- content_for :facebook_metadata_for_idea do
  = render partial: 'facebook_meta_tags'
- content_for :head do
  %title= "#{t('.title')} #{state_localised(@idea.state).capitalize}: #{shorten(@idea.title, 125, 15, "")}"
:javascript
  $(document).ready(function(){
      var r = Raphael("votepie");
      var pie = r.piechart(135, 92, 57, [
          // piechart requires non-zero sizes to draw properly, so let's guard these values
          // This hack works first to 0:1 situation, then until ~2300 with 0.0001, then till ~2347347 with 0.01
          #{@idea_vote_for_count      == 0 ? (@idea_vote_count > 2000 ? 0.1 : 0.0001) : @idea_vote_for_count},
          #{@idea_vote_against_count  == 0 ? (@idea_vote_count > 2000 ? 0.1 : 0.0001) : @idea_vote_against_count}
        ],
        {
          legend: [
              "#{@idea_vote_for_count} #{I18n.t('.vote_for')}-#{@idea_vote_for_count == 1 ? I18n.t('.vote') : I18n.t('.votes')} %%.%",
              "#{@idea_vote_against_count} #{I18n.t('.vote_against')}-#{@idea_vote_against_count == 1 ? I18n.t('.vote') : I18n.t('.votes')} %%.%"
            ],
          legendpos: "south", 
          colors: #{@colors.inspect},
          // Clicking portions could link somewhere
          // href: ["http://somewhere.com", "http://somewhere.com"]
        });

      r.text(130, 17, "#{@idea_vote_count} #{I18n.t('.votes_amount')}").attr({ font: "17px sans-serif" });
      pie.hover(function () {
          this.sector.stop();
          this.sector.scale(1.1, 1.1, this.cx, this.cy);

          if (this.label) {
              this.label[0].stop();
              this.label[0].attr({ r: 7.5 });
              this.label[1].attr({ "font-weight": 800 });
          }
      }, function () {
          this.sector.animate({ transform: 's1 1 ' + this.cx + ' ' + this.cy }, 500, "bounce");

          if (this.label) {
              this.label[0].animate({ r: 5 }, 500, "bounce");
              this.label[1].attr({ "font-weight": 400 });
          }
      });
  });
.prevnext
  .grid_24
    / This is a layout BUG: grid_12 + grid_12 does not fit in .grid_24 due some margins set somewhere
    / Workaround with grid_11 + grid_12 < grid_24
    .grid_11 
      - if @prev
        =link_to t('.previous'), idea_path(@prev, so: @sorting_order_code)
      - else
        .noprevnext &nbsp;
    .grid_12.right
      - if @next
        =link_to t('.next'), idea_path(@next, so: @sorting_order_code)
      - else
        .noprevnext
.clear
.grid_24
  = idea_state_image(@idea)
.idea.grid_24
  .author
    -if @idea.published?
      %img.avatar{ src: @idea.author.image, width: 48, height: 48 }
      %span.name= @idea.author.name
      %span.date.sans_serif= finnishDate(@idea.created_at)
      = link_to image_tag("email_big.png"), new_conversation_path(:recipient_id => @idea.author.id)
      %span.pull-right.impressions-count= "#{t('.impression_count')}: #{@idea.impressionist_count(:start_date => Date.today - 1.month)}"
  .grid_16.alpha.mainbody
    - if @idea.published?
      %h1= @idea.collecting_ended ? "#{state_localised(@idea.state).capitalize}: #{@idea.title.to_s} (Ended)" : @idea.title.to_s
      .summary
        = markdown(@idea.summary) if @idea.summary
      .body
        = markdown(@idea.body) if @idea.body
    - else
      %h1=t('.hidden_title')
      .summary
        =t('.hidden_summary_part_1')
        =link_to "kanslia@avoinministerio.fi", "mailto:kanslia@avoinministerio.fi"
        =t('.hidden_summary_part_2')
      .body
    - if @idea.author == current_citizen or administrator_signed_in?
      = link_to I18n.t("idea.links.edit_idea"), edit_idea_path(@idea)

  -if @idea.published?
    .grid_7.prefix_1.omega
      %iframe{width: "270", height: "152", src: "https://www.youtube.com/embed/jSmhaKseDbo", style: "border: none;", allowfullscreen: ""}
      .share
        %div{:class => "addthis_toolbox addthis_default_style addthis_32x32_style"}
          %a{:class => "addthis_button_facebook"}
          %a{:class => "addthis_button_twitter"}
          %a{:class => "addthis_button_gmail"}
          %a{:class => "addthis_button_google_plusone_share"}
          / This like does not seem to scale to 32x32 style
          /%a{:class => "addthis_button_facebook_like", "fb:like:width" => "115"}
        .sharing-suggestion
          - if @idea.voted_by?(current_citizen)
            - if @idea.votes.by(current_citizen).first.option == 0
              = t('.unsupport_idea')
            - else
              = t('.support_idea')
          - else
            = t('.share_idea')

  -if @idea.published?
    %aside.grid_7.prefix_1.omega
      .voting
        - if @idea.voted_by?(current_citizen)
          %h3= t('.voted_idea')
          %hr

        - case @idea.state
        - when "idea"
          - if @idea.voted_by?(current_citizen)
            %h3
              = t('.supported')
              %b #{vote_in_words(@idea, current_citizen)},
            %h4= t('.change_vote')
          - else
            %h3= t('.support')
          %h4= t('.notification_idea')
          = link_to t('.vote_yes'), vote_idea_path(@idea.id, vote: 1), class: "btn jaa-btn"
          = link_to t('.vote_no'), vote_idea_path(@idea.id, vote: 0), class: "btn ei-btn"
          .votes
            #votepie

        - when "draft"
          - if @idea.voted_by?(current_citizen)
            %h3
              = t('.supported')
              %b #{vote_in_words(@idea, current_citizen)},
            %h4= t('.change_vote')
          - else
            %h3= t('.do_you_believe')
          %h4= t('.notification_draft')
          = link_to t('.vote_yes'), vote_idea_path(@idea.id, vote: 1), class: "btn jaa-btn"
          = link_to t('.vote_no'), vote_idea_path(@idea.id, vote: 0), class: "btn ei-btn"
          .votes
            #votepie

        - when "proposal"
          / show voting for proposals if Signatures are not enabled, or if Signatures are enabled and this idea is not in given list
          /#- if((not ENV['Feature_Signatures']) || (not (ENV['Feature_Signatures'].split(/\,?\s+/).map{|s| s.to_i}.include?(@idea.id))))
          - if not @idea.collecting_started or @idea.collecting_ended
            - if @idea.voted_by?(current_citizen)
              %h3
                = t('.supported')
                %b #{vote_in_words(@idea, current_citizen)},
              %h4= t('.change_vote')
            - else
              %h3= t('.billing')
            %h4= t('.proposal_support_problem')
            %h4= t('.non_official_support')
            = link_to t('.vote_yes'), vote_idea_path(@idea.id, vote: 1), class: "btn jaa-btn"
            = link_to t('.vote_no'), vote_idea_path(@idea.id, vote: 0), class: "btn ei-btn"
            .votes
              #votepie
          - else
            - if @idea.voted_by?(current_citizen)
              %h3
                = t('.supported')
                %b #{vote_in_words(@idea, current_citizen)}
              %h4= t('.official_support_not_yet_possible')
              %h4= t('.support_notification')
            -if @idea.votes.empty?
              %h3= t('.not_supported_idea')
            -else
              %h4= t('.supported_idea')
              .votes
                #votepie
            %br
            %br
            = render "signature_info", idea: @idea

        - else # idea is already a law, no voting
          = t('.law_idea')
        
        = render "translations", idea: @idea

-if @idea.published?
  .idea_kartta
    %h2.grid_24= t(".nearest_collection_points")
    = render "geolocation"
-if @idea.published?
  .expert_opinions
    %h2.grid_24= t('.expert_opinions')
    - if @idea.articles.published.any?
      = render partial: 'article', collection: @idea.articles.published
      .clear
      .grid_17 &nbsp;
      .grid_7
        =link_to t('.are_you_expert'), "/artikkelit/asiantuntijoille-ja-tutkijoille", class: "grid_4"
        .clear
        =link_to t('.suggest_experts'), new_idea_expert_suggestion_path(@idea), class: "grid_4"
      .clear
    - else
      .grid_17
        = t('.no_statements')
      .grid_7
        =link_to t('.are_you_expert'), "/artikkelit/asiantuntijoille-ja-tutkijoille", class: "grid_4"
        .clear
        =link_to t('.suggest_experts'), new_idea_expert_suggestion_path(@idea), class: "grid_4"
      .clear

  .idea_comments#comments
    %h2.grid_24= t('.comments')
    .grid_24.comment_form
      = render "comments/form", model: @idea
    .comments.suffix_8
      = render partial: 'comments/comment', collection: @idea.comments.published

:javascript
  ideaShowPageTour();
